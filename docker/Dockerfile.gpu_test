FROM ubuntu:22.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV SHUTDOWN_AFTER_COMPLETION=true
ENV VAST_INSTANCE_ID=""

# Install system dependencies
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-dev \
    git \
    curl \
    wget \
    ftp \
    sudo \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip3 install --no-cache-dir -r requirements.txt

# Copy application files
COPY cuda_ftp_test.py .
COPY config.py .

# Make scripts executable
RUN chmod +x cuda_ftp_test.py

# Create startup script
RUN echo '#!/bin/bash\n\
echo "Starting GPU test instance..."\n\
echo "Instance ID: $VAST_INSTANCE_ID"\n\
echo "Auto-shutdown: $SHUTDOWN_AFTER_COMPLETION"\n\
\n\
# Run CUDA test with FTP upload\n\
python3 cuda_ftp_test.py\n\
\n\
# Check if we should shutdown\n\
if [ "$SHUTDOWN_AFTER_COMPLETION" = "true" ]; then\n\
    echo "Work completed, shutting down instance..."\n\
    sudo shutdown -h now\n\
else\n\
    echo "Keeping instance running for debugging..."\n\
    tail -f /dev/null\n\
fi' > /app/start.sh && chmod +x /app/start.sh

# Set entrypoint
ENTRYPOINT ["/app/start.sh"] 